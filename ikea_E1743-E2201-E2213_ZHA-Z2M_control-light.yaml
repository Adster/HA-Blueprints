blueprint:
  homeassistant:
    min_version: 2024.10.0
  author: damru (Modified for speed + 1% Lock)
  domain: automation
  name: Ikea's Remotes ðŸ’¡ Light control (Fast + 1% Lock)
  description: >
    ## ðŸ’¡ Control a light with **IKEA's remotes**
        
    Currently supported are:
      - Bilresa
      - RODRET
      - SOMRIG
      - TRADFRI ON/OFF

    Only for use with [ZHA](https://www.home-assistant.io/integrations/zha/)
    or Zigbee2MQTT (cf [MQTT](https://www.home-assistant.io/integrations/mqtt)
    + [Z2M addon](https://www.zigbee2mqtt.io/guide/installation/03_ha_addon.html)).


    Available controls:
      - Press **on** button to turn on the light
    (Optional: set the target brightness by enabling **Force Brightness** and setting a **Brightness** value)
      - Press **off** button to turn off the light
      - Hold **on** button to increase the brightness
      - Hold **off** button to decrease the brightness down to 1% (Will not turn off)
  input:
    remote_devices:
      name: Remotes
      description: >
        IKEA remote (Bilresa, Rodret, Somrig, Tradfri) to use.
      default: []
      selector:
        device:
          filter:
            - integration: zha
              manufacturer: IKEA of Sweden
              model: 09B9
            - integration: zha
              manufacturer: IKEA of Sweden
              model: RODRET Dimmer
            - integration: zha
              manufacturer: IKEA of Sweden
              model: RODRET wireless dimmer
            - integration: zha
              manufacturer: IKEA of Sweden
              model: SOMRIG shortcut button
            - integration: zha
              manufacturer: IKEA of Sweden
              model: TRADFRI on/off switch
            - integration: mqtt
              manufacturer: IKEA
              model: BILRESA remote control with buttons
            - integration: mqtt
              manufacturer: IKEA
              model: RODRET wireless dimmer/power switch
            - integration: mqtt
              manufacturer: IKEA
              model: SOMRIG shortcut button
            - integration: mqtt
              manufacturer: IKEA
              model: TRADFRI on/off switch
            # DEPRECATED - for removal, keeping for z2m v1 backward compatibility
            - integration: mqtt
              manufacturer: IKEA
              model: RODRET wireless dimmer/power switch (E2201)
            # DEPRECATED - for removal, keeping for z2m v1 backward compatibility
            - integration: mqtt
              manufacturer: IKEA
              model: SOMRIG shortcut button (E2213)
            # DEPRECATED - for removal, keeping for z2m v1 backward compatibility
            - integration: mqtt
              manufacturer: IKEA
              model: TRADFRI on/off switch (E1743)
          multiple: true
    light:
      name: Light
      description: Light to control
      selector:
        entity:
          filter:
            domain: light
          multiple: false
    brightness_section:
      name: Brightness
      icon: mdi:lightbulb-on-50
      collapsed: true
      input:
        helper_force_brightness:
          name: Force brightness
          description: Force the brightness to **Brightness** value when light turns on.
          default: false
          selector:
            boolean: {}
        helper_brightness:
          name: Brightness
          description:
            Target light brightness when turning on. Requires **Force brightness**
            to be enabled.
          default: 50
          selector:
            number:
              unit_of_measurement: "%"
              min: 1.0
              max: 100.0
              step: 1.0
              mode: slider
mode: restart
max_exceeded: silent

trigger_variables:
  mqtt_enabled: "{{ integration_entities('mqtt') != [] }}"
  remote_devices: !input remote_devices
  zha_enabled: "{{ integration_entities('zha') != [] }}"

triggers:
  ###########################
  # SINGLE PRESSES
  ###########################
  - trigger: event
    event_type: zha_event
    event_data:
      command: "on"
      cluster_id: 6
      endpoint_id: 1
    id: press-on-zha
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: "on"
    id: press-on-z2m
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data:
      command: "off"
      cluster_id: 6
      endpoint_id: 1
    id: press-off-zha
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: "off"
    id: press-off-z2m
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data:
      command: short_release
      endpoint_id: 1
    id: press-on-zha-somrig
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: 1_short_release
    id: press-on-z2m-somrig
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data:
      command: short_release
      endpoint_id: 2
    id: press-off-zha-somrig
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: 2_short_release
    id: press-off-z2m-somrig
    enabled: "{{ mqtt_enabled }}"

  ###########################
  # LONG PRESSES
  ###########################
  - trigger: event
    event_type: zha_event
    event_data:
      command: move_with_on_off
      cluster_id: 8
      endpoint_id: 1
    id: hold-on-zha
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: brightness_move_up
    id: hold-on-z2m
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data:
      command: move
      cluster_id: 8
      endpoint_id: 1
    id: hold-off-zha
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: brightness_move_down
    id: hold-off-z2m
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data:
      command: stop_with_on_off
      endpoint_id: 1
      cluster_id: 8
    id: release-zha
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: brightness_stop
    id: release-z2m
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data:
      command: long_press
      endpoint_id: 1
    id: hold-on-zha-somrig
    enabled: "{{ zha_enabled }}"
  - trigger: mqtt
    topic: "+/+/action"
    payload: 1_long_press
    id: hold-on-z2m-somrig
    enabled: "{{ mqtt_enabled }}"
  - trigger: event
    event_type: zha_event
    event_data
